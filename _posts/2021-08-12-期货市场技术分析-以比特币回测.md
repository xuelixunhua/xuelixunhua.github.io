---
title: 【量化】期货市场技术分析-以比特币为标的回测
categories:
 - 输出-量化
tags:
 - 量化
 - 金融
 - 区块链
---

## 可以靠一根简单移动平均线在数字货币里赚钱吗？

答案：大概是付出与收获不成正比。

但是，如果找到比较好的思路，也能超过市场许多。

**策略**：收盘价>均线，做多；收盘价<均线，做空

|标的|平均年化收益        |平均年化收益回撤比    |平均累计净值       |
|------|------------|-----------|-----------|
|btc   |0.011668929 |0.462009427|4.070278783|
|eos   |-0.05344739 |0.54980081 |2.333311622|
|eth   |-0.020791985|0.267942826|4.88300869 |

以上是多组参数结果的均值，并不能用净值直接计算年化，杠杆倍数为1、万五的手续费。

比如btc在最开始的那天价格是4260左右，9月20日的价格是11080左右，仅买入持有就是2.6倍，36%的年化。

也就是说仅看我们回测的全部数据没什么可赚的。

但是将结果按照周期来分类后可以得到：

|标的|周期 |累计净值        |
|------|---|------------|
|btc   |15T|0.093004911 |
|eos   |15T|0.059592177 |
|eth   |15T|9.24E-07    |
|btc   |1D |14.00293829 |
|eos   |1D |8.03834384  |
|eth   |1D |18.15317745 |
|btc   |1H |0.943896953 |
|eos   |1H |0.818320442 |
|eth   |1H |0.604721876 |
|btc   |30T|1.241274974 |
|eos   |30T|0.416990029 |
|eth   |30T|0.774134509 |

其中T为分钟，D为天，H为小时。

不难发现时间越长、收益越高，这个结果也和之前看的一篇论文结果一样：[时间长度太短的移动平均线交易策略不论交易成本如何效率不好，在实际运用中使用中长期均线策略较好](0 '李成林.移动平均线交易策略有效性比较研究[D].上海交通大学,2013')。 

[较短期的平均值产生较多的伪信号，但能更及时地揭示趋势信号；较长期地平均值相当迟钝，但可以避开很多随即噪音.](0 '期货市场技术分析.约翰·墨菲')

所以我们可以对天周期的进行回测，顺便加上杠杆，看看结果怎么样：

|标的|周期 |杠杆    |参数|累计净值       |年化收益       |最大回撤        |年化收益回撤比    |
|------|---|------------|----|-----------|-----------|------------|-----------|
|btc   |1D |3           |[14]|120.9659753|3.804113017|-0.773238248|4.919716563|
|btc   |1D |3           |[23]|41.14886744|2.379554555|-0.815977327|2.916201806|
|btc   |1D |3           |[11]|36.52261799|2.250606765|-0.864409284|2.603635577|
|eos   |1D |3           |[83]|80.4722206 |5.721637442|-0.627437448|9.119056346|
|eos   |1D |3           |[84]|74.70502128|5.5066521  |-0.650938155|8.459562642|
|eos   |1D |3           |[86]|69.4031916 |5.300608904|-0.650938155|8.143029967|
|eth   |1D |3           |[10]|34.14251767|2.107287664|-0.972994664|2.16577515 |
|eth   |1D |3           |[11]|31.99652338|2.042183693|-0.94317517 |2.165222068|
|eth   |1D |3           |[12]|22.65330652|1.718111182|-0.953495471|1.801908068|
|btc   |1D |2.5         |[14]|104.8600105|3.581291613|-0.710040728|5.043783363|
|btc   |1D |2.5         |[23]|42.90894313|2.423010721|-0.756224534|3.204089012|
|btc   |1D |2.5         |[11]|39.92372926|2.343437774|-0.806450389|2.905867251|
|eos   |1D |2.5         |[83]|52.21762593|4.575519643|-0.593738288|7.706290352|
|eos   |1D |2.5         |[84]|49.02090568|4.423660032|-0.608910619|7.264875816|
|eos   |1D |2.5         |[85]|45.93220095|4.271539977|-0.608910619|7.015052525|
|eth   |1D |2.5         |[10]|50.3547167 |2.537408802|-0.943221938|2.690150324|
|eth   |1D |2.5         |[11]|45.24622265|2.416106859|-0.895799845|2.697150345|
|eth   |1D |2.5         |[12]|34.85110126|2.137280279|-0.911198258|2.345571076|
|btc   |1D |2           |[14]|73.17656477|3.070478554|-0.630681035|4.86851258 |
|btc   |1D |2           |[23]|36.47202108|2.243421758|-0.677287982|3.312360205|
|btc   |1D |2           |[11]|34.97250803|2.199308312|-0.727079216|3.024853777|
|eos   |1D |2           |[83]|31.40751028|3.473986611|-0.549470835|6.322422211|
|eos   |1D |2           |[84]|29.82628325|3.374093257|-0.556926889|6.058413274|
|eos   |1D |2           |[85]|28.2337898 |3.270427457|-0.556926889|5.872274298|
|eth   |1D |2           |[10]|53.47106076|2.618041975|-0.887851825|2.948737504|
|eth   |1D |2           |[11]|47.07672865|2.47081556 |-0.819631742|3.014543523|
|eth   |1D |2           |[12]|38.95480977|2.262905256|-0.840290917|2.693002162|
|btc   |1D |1.5         |[14]|40.71912705|2.359117721|-0.529129465|4.458488662|
|btc   |1D |1.5         |[23]|24.45337727|1.844386586|-0.579111197|3.18485741 |
|btc   |1D |1.5         |[11]|24.04321601|1.828735748|-0.618957643|2.954541025|
|eos   |1D |1.5         |[83]|17.1292261 |2.439737708|-0.488739146|4.991901566|
|eos   |1D |1.5         |[84]|16.4625221 |2.380560248|-0.489688062|4.861381017|
|eos   |1D |1.5         |[85]|15.77281674|2.317903681|-0.489688062|4.733429018|
|eth   |1D |1.5         |[10]|40.00600663|2.30112103 |-0.789764205|2.913681092|
|eth   |1D |1.5         |[11]|35.30132808|2.169118722|-0.702038267|3.089744283|
|eth   |1D |1.5         |[12]|31.04312075|2.038988548|-0.7267962  |2.805447454|
|btc   |1D |1           |[14]|17.1680326 |1.532227104|-0.399600389|3.834398432|
|btc   |1D |1           |[23]|12.57370106|1.28761977 |-0.467905134|2.751882116|
|btc   |1D |1           |[11]|12.26708122|1.269271878|-0.472304691|2.687400534|
|eos   |1D |1           |[83]|8.264074602|1.506597106|-0.40025967 |3.764049239|
|eos   |1D |1           |[84]|8.042074904|1.476937422|-0.40025967 |3.689948132|
|eos   |1D |1           |[85]|7.808882012|1.445281679|-0.40025967 |3.610860118|
|eth   |1D |1           |[10]|19.89753252|1.636440979|-0.627843544|2.60644709 |
|eth   |1D |1           |[11]|17.93724573|1.548740332|-0.533094141|2.905191062|
|eth   |1D |1           |[12]|16.6247541 |1.486344737|-0.557624257|2.665495123|

|标的 |平均年化收益|平均年化收益回撤比     |平均累计净值|
|---|----|------------|----|
|btc|2.294438792|3.511372554 |44.14505152|
|eos|3.432342885|6.107503101 |35.64655639|
|eth|2.099393041|2.633871088 |34.63713168|

有点不可思议...唯一不好的风险太大，很多效果好的参数拟合性强，比如有不少回撤达到90%了，这种在实盘里肯定是用不了的。

同样可以看出来btc和eth大概10天左右的平均线效果最好，eos则是80天左右的均线，横坐标为参数day：

![1](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\1.png)

![2](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\2.png)


但是当我们把时间参数继续扩大到100-500时，效果也就一般般，通常3倍左右的净值。

接下来我们挑选了累计净值最高的参数，它的盈利笔数有45笔，亏损笔数有94笔，胜率也就是32.37%。

想一下，如果你去交易10笔，只有3笔盈利，你会继续玩吗？所以这种方法虽然回测起来效果蛮好的，但大多数人实盘运行会崩溃的，这也是之后为什么我们要加过滤器的原因——降低回撤、提高胜率。

个人认为其收益高的原因在于均线可以很好的找到大趋势，而数字货币这两年存在不少小牛和大牛，抓住趋势自然就收益不低，但其胜率低的原因是由于支撑区和阻挡区的存在，均线会在这种位置来回突破，就产生一大堆伪信号而导致开了很多亏单。

### 单向做多

在[移动平均线分析法及其交易策略研究](单向做多、单向做空、多空双向交易 '陈标金,陈文杰.移动平均线分析法及其交易策略研究[J].商业研究,2015,(7):73-79.')这篇文章里，作者指出了单向做多、单向做空、多空双向交易等策略方法，但在他的测试里，单向做多没有多空双向交易收益大，我们可以测下在数字货币市场这里是不是这样：

|标的 |年化收益|年化收益回撤比     |累计净值|
|---|----|------------|----|
|btc|0.10852341|0.621189748 |3.013701642|
|eos|-0.339020745|-0.278795346|0.719969273|
|eth|0.028597968|0.246440947 |2.684935134|

相比之前的数据，看起来确实是这样。

### 数据参数

我们选取的是币安交易所btc, eth, eos现货截止到2020年9月20日的5min数据。

k线周期为15min、30min、1h、1d。

## 给移动平均线套上盾

说实话，很难想象得到一根简单的移动平均线就能在数字货币市场上获得超额收益。

但同样数据也证明btc的累计净值是最大的，可能与其交易时间更长有关；但其他两个币种也在不同的方面表现出色，比如eos虽然累计净值没有优势，但也不逊色多少，加上其上市时间短的原因，其年化很客观；又比如eth虽然各个数据都很出色，很多地方也超过了btc，但随着杠杆的上升，eth累计净值高的同时也带来了回撤很大的情况，很多参数直接就90%的最大回撤，所以这些参数也没什么实用价值.

也正是以上单独使用一根移动平均线带来各种各样的问题，所以人们想出了给他们加各种各样过滤器的方法，以提高各种各样的数据。

在[期货市场技术分析](0 '期货市场技术分析.约翰·墨菲')中提出了以下几种过滤伪信号的方法：

1. 不仅要求收盘价穿越移动平均线，也要求当天的全部价格范围清晰地突出在移动平均线地同一侧。
2. 穿越幅度必须达到设定的要求；同样过滤器越大信号发生的越迟。
3. 由其他图表地突破信号所验证；如点数图、周规则；同样对过滤器越倚重就会越偏离移动平均线的本意。
4. 时间过滤器；如等待信号n时，代价是入场时间延迟。
5. 百分比包络线、波幅带；类似布林带，具体是在移动平均线的上方和下方的一定的百分比位置上分别作出其平移曲线，当收盘价不仅高于移动平均线自身，且高于上包络线后才构成买入信号。
6. 针对最高价与最低价，做移动平均线得到价格带，收盘价穿越上边线构成买入信号，下边线确定止损出市点。

我们一起来分析一下：

### 当天全部价格处在同一侧

这个说的就挺模糊，我有以下三个思路：

1. 在非日K线数据里，收盘价上穿后，后面一段时间的数据的最低价都高于移动平均线，反之亦然(为什么不是前面一整天，是因为前面价格高于移动平均线的话必然带有一根上穿的线，从而导致信号可能是下跌的信号)(双参数)
2. 在日K线数据里，收盘价上穿后后面一段时间的数据的最低价都高于移动平均线，反之亦然(双参数)
3. 在日K线数据里，收盘价上穿后第二天的最低价高于移动平均线，反之亦然(数字货币市场不存在跳空的现象)(单参数)

关于前两个情况，直接一起回测了：

|标的 |周期 |para    |累计净值       |年化收益       |最大回撤        |年化收益回撤比    |
|---|---|--------|-----------|-----------|------------|-----------|
|btc|15T|[41, 15]|80.33947096|3.178371806|-0.580183861|5.478214788|
|btc|15T|[61, 15]|54.57857318|2.68364947 |-0.503331729|5.33177091 |
|btc|15T|[51, 15]|43.38172491|2.41803363 |-0.608477295|3.973909378|
|btc|15T|[51, 13]|32.40941275|2.108134229|-0.635715381|3.31616049 |
|btc|15T|[71, 17]|16.42492943|1.490523426|-0.467595423|3.187634762|
|btc|1D |[31, 3] |17.69883423|1.553052218|-0.502836013|3.088585894|
|btc|1D |[21, 3] |12.47566527|1.277815523|-0.588340406|2.171898293|
|btc|1D |[81, 1] |8.774607522|1.034334334|-0.550817354|1.87781726 |
|btc|1D |[91, 11]|5.792645739|0.773529155|-0.341551585|2.264750593|
|btc|1D |[91, 13]|5.612524675|0.755349131|-0.323123415|2.337649011|
|btc|1H |[61, 1] |14.48104664|1.392426414|-0.457159005|3.045825191|
|btc|1H |[51, 5] |13.79622255|1.352286728|-0.580647786|2.328927725|
|btc|1H |[91, 1] |10.54312175|1.157299832|-0.543592234|2.128985219|
|btc|1H |[61, 3] |9.196821325|1.061011417|-0.587251503|1.806741083|
|btc|1H |[51, 3] |6.882252566|0.877280158|-0.44969846 |1.950818686|
|btc|30T|[21, 7] |16.33927201|1.486966598|-0.733020204|2.028547903|
|btc|30T|[41, 7] |11.76086825|1.234220191|-0.449792318|2.743977923|
|btc|30T|[21, 5] |11.73774187|1.232787218|-0.536674805|2.297084208|
|btc|30T|[21, 9] |8.857353427|1.036992424|-0.695176742|1.491696086|
|btc|30T|[91, 5] |6.894463181|0.877261051|-0.62294637 |1.408244903|
|eos|15T|[51, 19]|17.99969722|2.540970177|-0.594431471|4.274622558|
|eos|15T|[91, 19]|11.54088382|1.907703342|-0.601238887|3.172954015|
|eos|15T|[71, 15]|5.849757257|1.16743473 |-0.615975036|1.895263059|
|eos|15T|[91, 17]|5.151992816|1.050478767|-0.667764179|1.573128358|
|eos|15T|[71, 13]|4.395155508|0.913026473|-0.57312558 |1.593065299|
|eos|1D |[61, 7] |5.419023417|1.093224352|-0.662471378|1.650221259|
|eos|1D |[61, 5] |5.380100266|1.086638841|-0.645359907|1.683771845|
|eos|1D |[61, 9] |5.260874025|1.066298095|-0.643770775|1.656331938|
|eos|1D |[51, 9] |5.036835628|1.027361731|-0.631989068|1.625600478|
|eos|1D |[51, 5] |4.715062138|0.969693686|-0.467355136|2.074854027|
|eos|1H |[41, 13]|4.919005849|1.01284307 |-0.596898941|1.696841795|
|eos|1H |[91, 1] |3.151338313|0.646891407|-0.619008183|1.045045   |
|eos|1H |[81, 11]|2.543207494|0.499675407|-0.778038628|0.642224421|
|eos|1H |[41, 17]|2.349040731|0.457529156|-0.789662856|0.579398097|
|eos|1H |[1, 1]  |1.796721297|0.288517827|-0.265183933|1.087991357|
|eos|30T|[31, 15]|6.35474989 |1.241500325|-0.696854328|1.781577978|
|eos|30T|[41, 19]|4.767595046|0.977128337|-0.747228924|1.307669319|
|eos|30T|[61, 19]|4.456184729|0.923925393|-0.820317145|1.126302673|
|eos|30T|[71, 19]|3.244447859|0.67121037 |-0.769582158|0.872175068|
|eos|30T|[71, 11]|2.996213756|0.614113675|-0.637256841|0.963683142|
|eth|15T|[21, 11]|9.532783004|1.082804336|-0.901968977|1.200489555|
|eth|15T|[41, 15]|3.236465983|0.469634987|-0.841849114|0.557861235|
|eth|15T|[81, 5] |2.277648599|0.310614639|-0.800428741|0.388060327|
|eth|15T|[51, 11]|1.896369549|0.234643049|-0.813255384|0.288523204|
|eth|15T|[71, 7] |1.745184951|0.201657605|-0.911616121|0.221208906|
|eth|1D |[61, 1] |9.649409734|1.109798041|-0.61627718 |1.800809891|
|eth|1D |[71, 3] |8.798013231|1.032559359|-0.654660626|1.577243717|
|eth|1D |[71, 9] |6.763675068|0.865487755|-0.592782374|1.460042998|
|eth|1D |[41, 13]|4.723051283|0.65928393 |-0.352211338|1.871841873|
|eth|1D |[41, 15]|3.641485016|0.524333967|-0.302166762|1.735246999|
|eth|1H |[71, 7] |102.4939756|3.536202364|-0.535122032|6.608216726|
|eth|1H |[81, 3] |46.8299997 |2.514045113|-0.543876648|4.622454596|
|eth|1H |[91, 1] |31.13362734|2.076206203|-0.595784917|3.484825048|
|eth|1H |[81, 5] |26.50949893|1.90494942 |-0.818897456|2.326236828|
|eth|1H |[71, 5] |24.369982  |1.840148246|-0.571127306|3.221958094|
|eth|30T|[41, 5] |12.54469633|1.277007801|-0.689446899|1.852220676|
|eth|30T|[51, 7] |7.90117877 |0.958499217|-0.638538164|1.501083681|
|eth|30T|[91, 3] |7.03006244 |0.885327924|-0.837312252|1.057345   |
|eth|30T|[91, 1] |3.18963962 |0.457182468|-0.798444002|0.572591774|
|eth|30T|[61, 11]|2.836529102|0.402507465|-0.82829124 |0.485949199|

|标的 |平均年化收益|平均年化收益回撤比 |平均累计净值       |
|---|----|--------|-----------|
|btc|1.449066248|2.712962015|19.39887761|
|eos|1.007808258|1.615136084|5.366394353|
|eth|1.117144694|1.841710516|15.85516381|

以上是选取了每个币种每个周期年化收益回撤比最高的5个参数地结果。

无论是哪个币种，相比什么也不加的单均线策略效果要好多了，相对于之前只有日K线的收益不错的情况下，加上过滤器后不论是哪个周期都有不错的收益。

不过虽然收益高了，但风险也有所加大，在没有杠杆的情况下居然的都有80%的回撤，另外平均收益btc最高，eos最低，原因可能很大程度上是因为前者交易时间更长。

|标的 |周期 |累计净值    |
|---|---|--------|
|btc|15T|45.42682225|
|eos|15T|8.987497324|
|eth|15T|3.737690417|
|btc|1D |10.07085549|
|eos|1D |5.162379095|
|eth|1D |6.715126866|
|btc|1H |10.97989297|
|eos|1H |2.951862737|
|eth|1H |46.26741671|
|btc|30T|11.11793975|
|eos|30T|4.363838256|
|eth|30T|6.700421253|

但不同的币种也有不同的特点，比如btc在这个策略下似乎非常适合短线进出，eth在1h的K线下表现也非常好，eos...不太适合这个策略？

下面的图里，竖轴是n时的移动平均线，横轴是m时的最低价都高于移动平均线(或者是最高价都低于移动平均线)，颜色的深浅代表年化收益的高低(代码感谢@木木公子)：

![one_simple_signal_moving_average_oneside_v1-1D](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\one_simple_signal_moving_average_oneside_v1-1D.png)

![one_simple_signal_moving_average_oneside_v1-15T](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\one_simple_signal_moving_average_oneside_v1-15T.png)

![one_simple_signal_moving_average_oneside_v1-1H](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\one_simple_signal_moving_average_oneside_v1-1H.png)

![one_simple_signal_moving_average_oneside_v1-30T](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\one_simple_signal_moving_average_oneside_v1-30T.png)

可以看出1D的k线情况下亮度比较宽阔集中，也就是代表其参数高原比较集中(表现较好的参数比较集中的某一区域)，而15min的k线虽然btc表现特别好，但普遍都是一点亮度集中的地方，代表好的参数非常少，未来可能价格走势一变，这个参数效果就不好了。

总的来说，这个过滤器是非常成功的，但是对于回撤的减少没有什么太明显的帮助。

第三种情况，在日K线数据里，收盘价上穿后第二天的最低价高于移动平均线，反之亦然：

|symbol|周期 |para|累计净值       |年化收益        |最大回撤        |年化收益回撤比     |
|------|---|----|-----------|------------|------------|------------|
|btc   |1D |[6] |46.82738206|2.512747593 |-0.580959127|4.325171039 |
|btc   |1D |[21]|36.96320682|2.246246682 |-0.520036685|4.319400432 |
|btc   |1D |[26]|21.92086604|1.737577705 |-0.718774896|2.417415682 |
|btc   |1D |[16]|15.75193843|1.457826976 |-0.668121161|2.181979949 |
|btc   |1D |[11]|9.26515827 |1.067150122 |-0.525510501|2.030692288 |
|eos   |1D |[6] |24.8945635 |3.076366572 |-0.408650113|7.528118737 |
|eos   |1D |[21]|12.14056003|1.978164361 |-0.595377915|3.322535675 |
|eos   |1D |[61]|10.73581601|1.822308912 |-0.374838186|4.861588233 |
|eos   |1D |[36]|10.09030572|1.746834095 |-0.52558086 |3.323625776 |
|eos   |1D |[56]|8.611990415|1.563054458 |-0.45909015 |3.404678709 |
|eth   |1D |[11]|50.92411862|2.629808403 |-0.725500473|3.624819696 |
|eth   |1D |[21]|25.05131284|1.87997459  |-0.566507666|3.318533362 |
|eth   |1D |[26]|9.880852164|1.126172569 |-0.804726863|1.399446969 |
|eth   |1D |[16]|1.832990302|0.227300925 |-0.937477171|0.242460225 |
|eth   |1D |[1] |0.752165846|-0.088712387|-0.898639105|-0.098718592|

|symbol|年化收益|年化收益回撤比|累计净值       |
|------|----|-------|-----------|
|btc   |1.804309815|3.054931878|26.14571032|
|eos   |2.03734568|4.488109426|13.29464713|
|eth   |1.15490882|1.697308332|17.68828795|

一个参数的表现却比两个参数的表现更好，可以直接拿上表与之前以“周期”分组的表对照，比如btc之前只有10，而这里到了26。

这个策略相比上一个策略需要计算量少多了，之前取得判断值是一段时间的，而这里只取第二天的，整体上相对于没有加过滤器的特点表现在开仓的时候能抓住更多的大趋势而放走假信号了。

我们再看下参数平原：

![one_simple_signal_moving_average_oneside_v2-1D](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\one_simple_signal_moving_average_oneside_v2-1D.png)


这图让我感觉自己策略写错了...赶紧挑一个值回测下详细信息...

另外对于eos来说，尽管累计净值不高，但年化收益超过其他，而且各个位置的参数对策略都很友好。

对于btc和eth后面参数全部阵亡的奇怪现象，我们回测了其中一个参数，btc的[31]，结果是这样的：

![3](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\3.png)

一根K线上穿MA且第二根K线最低价在MA之上，因此开多，尽管第三根K线下穿MA，但第四根K线最高价没有低于MA，因此没有平多开空，直到爆仓。

所以如果我们加了止盈或者止损指令、考虑这种情况后策略可能整体收益没有提高，但后面会允许更大的参数加入。

综上，原本一条移动平均线带来的作用十分有限，但是他很好的追踪了趋势，当我们通过各种方法过滤掉部分假信号时，移动平均线的力量也让我们越来越震惊，毕竟这些数字货币这两年都有大趋势，而移动平均线可以很好地追踪这些大趋势。

不禁有点期待双均线。

### 穿越幅度必须达到设定的要求

根据我的理解，仅突破n日平均线是不够的，该策略还要求其突破的幅度大于m%(双参数)：

| symbol | 年化收益 | 年化收益回撤比 | 累计净值 |
| ------ | -------- | -------------- | -------- |
| btc    | 1.241745 | 2.068181       | 14.09449 |
| eos    | 1.201698 | 2.751181       | 6.41011  |
| eth    | 0.871068 | 1.421793       | 7.796306 |

和上一个过滤器的结果差不多，不同的币种表现不一。

| symbol | 周期 | 累计净值 |
| ------ | ---- | -------- |
| btc    | 15T  | 20.97596 |
| eos    | 15T  | 3.58619  |
| eth    | 15T  | 5.042894 |
| btc    | 1D   | 6.808133 |
| eos    | 1D   | 5.598234 |
| eth    | 1D   | 13.20548 |
| btc    | 1H   | 14.63595 |
| eos    | 1H   | 7.719838 |
| eth    | 1H   | 5.403714 |
| btc    | 30T  | 13.95791 |
| eos    | 30T  | 8.736177 |
| eth    | 30T  | 7.53314  |

反正仅凭肉眼的感觉看来，是上一个过滤器的效果好一些，毕竟从条件上来看，上一个过滤器兼顾了**时间和价格**两个维度的过滤条件，而这个只有**价格**一个维度的过滤条件。

像之后的第四点提出的过滤器，则是只有**时间**一个维度的过滤条件，因此也不去做他的回测了。

至于第五点百分比包络线，其实就是我们上述的策略，属于价格维度的百分比突破，当然第二点满足的要求可以不止是百分比，也可以是固定的数值等等，包含了第五点。

关于第三点，如果有机会之后再验证。

### 最高价与最低价的价格带

收盘价大于最高价均线，买入，收盘价小与最低价均线，卖出。

| symbol | 周期 | 累计净值 |
| ------ | ---- | -------- |
| btc    | 15T  | 0.084106 |
| eos    | 15T  | 0.025123 |
| eth    | 15T  | 0.015021 |
| btc    | 1D   | 4.321987 |
| eos    | 1D   | 4.241656 |
| eth    | 1D   | 11.8166  |
| btc    | 1H   | 3.982558 |
| eos    | 1H   | 0.912836 |
| eth    | 1H   | 5.505526 |
| btc    | 30T  | 0.495649 |
| eos    | 30T  | 0.020991 |
| eth    | 30T  | 0.322399 |

比较明显，该策略也是在长周期里里面如鱼得水，但相对于其他过滤器来说并不占优势，甚至相比原始的单均线策略还略显不如，比如在日K上就不行，但在1H的K线上效果还行。

在修改上，这个策略稍微一改就可以变成布林带突破策略，也可以加上中线平仓的信号等等。

整体来说，书上给的这些过滤器中有四个都是从**价格**和**时间**两个维度上考虑的，尤其是第一个结合了时间和维度，回测下来这个过滤器效果也是最好的，另外第三点是引入了其他判断方式，第六点是改变了计算移动平均线本身的参照值。

在仅仅加了过滤器的单均线策略就有这么好的收益，真是期待多加一根均线的结果。

## 两条腿的移动平均线

我们之前一直在搞一条移动平均线，接下来我们引入第二条，较长期用来识别趋势，较短期用来选择时间。

对于之前参考的一根移动平均线，我们只能不停地跟着他跑，很难停下来，路上会有很多坑让我们摔倒，但是当我们找到另外一根均线的时候，就忽然不一样了，我们一边可以驾着马车看着远方的路是上坡还是下坡，另一边可以看着眼前的路是否已经有坡度了。

比如我们很早就发现前面是一条大下坡，于是我们就可以逐渐放慢速度，否则下坡时有可能因为速度太快而人仰马翻，但具体什么时间放慢速度呢？太早放慢速度就很难保持一个匀速到达坡前，还得重新加速，太晚放慢就可能人仰马翻，短均线给了我们这样一个参考标准。

### 双线交叉法

短期平均线上穿长期平均线时，买入；短期平均线下穿长期平均线时，卖出。

| symbol | 年化收益 | 年化收益回撤比 | 累计净值 |
| ------ | -------- | -------------- | -------- |
| btc    | 1.404795 | 3.125352       | 15.28342 |
| eos    | 0.752004 | 1.35495        | 3.817659 |
| eth    | 2.341397 | 4.995441       | 43.29481 |

多加上一根线以后，果然策略的效果如有神助，非常的耀眼，这个策略打败了之前除了第一个过滤器中第二个思路的其他所有策略，而ETH更是犹如一颗闪亮的太阳，即便是之前加了杠杆的策略也没有它表现的好。

原因也许在于ETH超高的波动率正好被这个策略捕捉到了？？？

| symbol | 周期 | 累计净值 |
| ------ | ---- | -------- |
| btc    | 15T  | 12.60057 |
| eos    | 15T  | 2.213186 |
| eth    | 15T  | 22.7802  |
| btc    | 1D   | 9.440882 |
| eos    | 1D   | 6.445163 |
| eth    | 1D   | 35.7488  |
| btc    | 1H   | 18.17308 |
| eos    | 1H   | 3.701077 |
| eth    | 1H   | 49.65542 |
| btc    | 30T  | 20.91914 |
| eos    | 30T  | 2.911209 |
| eth    | 30T  | 64.99484 |

这个表格更清晰地说明ETH在这个策略下是真的如鱼得水，仅净值而言，通常是同周期BTC的2倍左右，BTC和EOS在这个策略下不比其他策略有很大的优势，有的情况也没超过其他策略，但ETH跳出来大喊一声：我喜欢！

于是我们查看了表现最好的一个参数：30T的[56, 151]，发现它有一个很亮眼的优点，就是不停的追随趋势，当标的涨的时候资金曲线在涨，当标的跌的时候资金曲线也在涨...害...

![4](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\4.PNG)

当我们查看ETH的参数平原，发现有一部分是黑的，很正常，因为我回测的时候长均线和短均线前面的参数区间是一样的，因为前面的区间相当于两根均线贴着，以此产生的信号最后归零很正常：

![5](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\5.png)

另外我们也可以看到除了日K线外的周期亮度一大片，代表这个策略在ETH上跑的是真的好，因此大家有没有兴趣看下加了杠杆是什么情况？

#### 加了杠杆之后

以下是3倍杠杆下的情况：

| 年化收益 | 年化收益回撤比 | 累计净值 |
| -------- | -------------- | -------- |
| 4.318296 | 4.850593       | 238.2705 |

以下是按周期分组的情况：

| 周期 | 累计净值 |
| ---- | -------- |
| 15T  | 19.03031 |
| 1D   | 216.1466 |
| 1H   | 237.7189 |
| 30T  | 480.1861 |

除了15分K线外，效果都蛮好的，不再赘述了。

### 中性区平仓

把中间看作中性区，收盘价上穿两条平均线后，买入；价格跌回中性区，平仓，下穿两条均线后，卖出。

如果严格执行收盘价同时穿过两根平均线这个规则的话，满足的情况非常少，别的策略可能在这个区间做几百次交易，我挑选了其中一个表现不错的参数，只开了10+次仓，而且尽管大多数回撤只有20%左右，但整体净值也非常低。

|symbol|年化收益       |年化收益回撤比    |累计净值       |
|------|-----------|-----------|-----------|
|btc   |0.296950135|1.750013668|2.98112982 |
|eos   |0.697512857|3.171833428|3.791177892|
|eth   |0.426257471|1.690022755|3.810507242|

因此退一步讲，收盘价同时大于两根均线即可开仓，而不要求同时穿过的话(穿过=上一根K线低于)，可能增加开仓几率，但事实是效果更差了...头部参数的开仓几率倒没有增加，反而是回撤变大了。

### 再加一条腿

对于多方，在快速和中速均线都在慢速均线之上的情况下，当快速均线往上穿过中速均线时就买进，而当快速均线往下穿过慢速均线时就卖出，至于空方，反之亦然，简而言之，快和中决定进场，快和慢则决定出场

![公众号封面](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\6.png)

|symbol|年化收益       |年化收益回撤比    |累计净值       |
|------|-----------|-----------|-----------|
|btc   |1.009748773|3.519454859|9.519552842|

|symbol|周期         |累计净值       |
|------|-----------|-----------|
|btc   |15T        |6.383033851|
|btc   |1D         |4.327976563|
|btc   |1H         |14.64099426|
|btc   |30T        |12.72620669|

整体来说效果并没有因为多加一条均线而变好，甚至有所不如，比如表现比较好的参数的胜率也只有30%左右，可能这也是为什么大自然界没有三条腿的动物。

这也可能印证了书上说的[美林公司对商品市场的研究](10例表明双平均线获利能力最强，而三平均线只在4例中占到上风 '期货市场技术分析.约翰·墨菲')。

当然引入第三条均线的时候可以改进的地方就多很多了，各种过滤器、开仓条件等等。

移动平均线的实证就到这里结束了，有兴趣的同学继续关注啊~

## 番外

当我们在开仓条件这个维度上搜肠刮肚很长时间之后，也许可以转向另外一个维度作战：**移动平均线的计算方式**。

这就好比大家都在努力刷卷子以便能够在高考中考更高的分、有更好的学校选择，但是，你忽然走了自主招生，只要高考分达到XXX分即可录取。

在[墨菲](0 '期货市场技术分析.约翰·墨菲')的那本书里，提到除了我们之前一直在用的简单移动平均线外，还有两种常见的移动平均线，分别是：线性加权移动平均线和指数加权移动平均线。

原因在于简单移动平均线有两个问题：每个平均值仅把它所覆盖的那段时间包括进来；简单移动平均值对其中每一天都一视同仁。

人们为了解决这两个问题就提出后面两种方法。

### 线性加权移动平均线

在这种算法中，如果以10天平均值为例，那么第10天的要乘以10，第9天的要乘以9，等等，这样越后面的权重越大，但他仍然没有解决前一个问题。

关于计算它的方法，我们在[stack overflow](https://stackoverflow.com/questions/9621362/how-do-i-compute-a-weighted-moving-average-using-pandas 'stack overflow, 关于线性加权移动平均线的算法')中得到。

最后我们得到的结果是这样(日周期)：

|symbol|年化收益       |年化收益回撤比    |累计净值       |
|------|-----------|-----------|-----------|
|btc   |0.747496678|2.059884401|5.703818253|
|eos   |0.823236154|1.741544712|3.975221197|
|eth   |1.069290799|2.08371666 |9.908697723|

而简单移动平均线是这样的：

|symbol|年化收益       |年化收益回撤比    |累计净值       |
|------|-----------|-----------|-----------|
|btc   |1.263270416|2.823976066|12.37056851|
|eos   |1.454925737|3.634954621|7.881942122|
|eth   |1.513185223|2.512807595|17.23816438|

可以发现，效果其实不好...

### 指数加权移动平均线

这个可以直接用pandas里面的`ewm`函数进行计算：

|symbol|年化收益       |年化收益回撤比    |累计净值       |
|------|-----------|-----------|-----------|
|btc   |0.908792193|1.706626473|7.519958042|
|eos   |1.014967563|2.047275531|5.06656078 |
|eth   |1.173600219|1.963630639|11.84546928|

同样效果比不上简单移动平均线。

但相比线性加权的来说，年化收益和累计净值稍微高了些，但年化收益回撤比却有所降低，说明回撤应该更大些。

当然我们也不知道加了过滤器是什么样子，也许会比简单移动平均线加过滤器效果好些，但就不做试验了。

## 周规则

[书上云](0 '期货市场技术分析.约翰·墨菲')：在过去十年中，随着计算机技术的进步，关于在期货市场建立技术性交易系统的问题，人们进行了大量的研究。这些系统在本质上是自动化的，消除了人类情感和主观判断的影响。另一方面，它们也越来越臻于复杂。起初用的是简单的移动平均法，后来，又加入了双移动平均线交叉、三移动平均线交叉的内容，再后来，又把移动平均值线性加权、指数加权。最近，人们又引入了高级的统计学系统，例如线性回归系统。上述系统的首要目的依然是追随趋势，即首先识别趋势，然后顺着既有趋势的方向交易。 不过，随着越来越复杂、越来越富于想象力的系统和指标的出现，也有些不妥的倾向。人们往往忽视了那些简单、基本的工具，而它们的效果相当好，经受住了时间的考验。

于是作者就介绍了这个叫做“周规则”的策略：

- 价格涨过前四个日历周内的最高价，则平回空头头寸，开立多头头寸。
- 价格跌过前四个周内(照日历算满)的最低价，则平回多头头寸，建立空头头寸。

跟之前的移动平均线一样，也是个连续在市的策略，逻辑上不会出现空仓的情况。

同时作者也说，他可以抓住正确的趋势，结构上也体现了把损失控制在小额的特点，同时产生的交易往往不太频繁、佣金很低。

整体听起来很棒，我们来回测一下：在收盘价上穿过去28天(4周)的最高值后做多，收盘价下穿过去28天(4周)的最低值后做空。

> PS: 这个策略非常类似移动平均线那里的最高价与最低价形成的价格带，不同点是它的值求得是平均值，而本策略关注的是最值。

| 指标             | BTC                  | ETH                  | EOS                  |
| ---------------- | -------------------- | -------------------- | -------------------- |
| 累积净值         | 4.58                 | 3.51                 | 0.05                 |
| 年化收益         | 0.64 倍              | 0.49 倍              | -0.73 倍             |
| 最大回撤         | -93.17%              | -94.58%              | -98.97%              |
| 最大回撤开始时间 | 2017-12-17 00:00     | 2019-1-5 00:00       | 2019-5-30 00:00      |
| 最大回撤结束时间 | 2018-11-14 00:00     | 2019-3-4 00:00       | 2020-9-18 00:00      |
| 年化收益/回撤比  | 0.69                 | 0.52                 | 0.74                 |
| 盈利笔数         | 8                    | 8                    | 5                    |
| 亏损笔数         | 8                    | 5                    | 8                    |
| 胜率             | 50.00%               | 61.54%               | 38.46%               |
| 每笔交易平均盈亏 | 31.59%               | 46.63%               | 1.64%                |
| 盈亏收益比       | 3.29                 | 2.27                 | 1.69                 |
| 单笔最大盈利     | 296.15%              | 235.93%              | 193.12%              |
| 单笔最大亏损     | -45.44%              | -80.44%              | -63.15%              |
| 单笔最长持有时间 | 191 天 0 小时 0 分钟 | 209 天 0 小时 0 分钟 | 239 天 0 小时 0 分钟 |
| 单笔最短持有时间 | 16 天 0 小时 0 分钟  | 20 天 0 小时 0 分钟  | 5 天 0 小时 0 分钟   |
| 平均持仓周期     | 68 天 21 小时 0 分钟 | 85 天 3 小时 41 分钟 | 63 天 7 小时 23 分钟 |
| 最大连续盈利笔数 | 3                    | 3                    | 3                    |
| 最大连续亏损笔数 | 3                    | 2                    | 4                    |

这个策略收益一般/不好，回撤非常大，交易次数很少，持仓时间很长，总体来说，不是一个实盘的好策略，但作为判断趋势的指标来说，可以参考。

###  修正

针对连续在市这个情况，可以使其不连续在市，方法是采用较短的时间跨度作为平仓信号，书上提了一周和两周两个参数，于是在之前的策略上再加上：

- 收盘价下穿一周(或两周)的收盘价，平仓。
- 收盘价上穿一周(或两周)的收盘价，平仓。

| symbol | 年化收益    | 年化收益回撤比 | 累计净值    |
| ------ | ----------- | -------------- | ----------- |
| btc    | 0.225106005 | 0.343711032    | 1.863543947 |
| eos    | 0.300769695 | 0.696844354    | 1.843930353 |
| eth    | 0.477291861 | 1.013731969    | 3.308382912 |

这样弄了以后回撤小了很多，比之前大多数的移动平均线策略回撤要小。

其他的，个人认为不适合严格的执行(至少是数字货币市场)，可以作为主观交易判断趋势的一个标准。

## 摆动指数在数字货币市场中的表现

有时候市场进入无趋势阶段阶段，一会上、一会下，很有可能一次极值突破移动平均线，导致开多，但很快就又跌下去，从而亏钱，像以移动平均线这种追踪趋势为主要构造指标的策略就会开始亏钱。

那有没有指标可以在这种震荡区间里赚钱呢？

[书](0 '期货市场技术分析.约翰·墨菲')里面提到一种指标——摆动指数，具体有以下几种：

1. ROC变化速度指数
2. 移动平均线摆动指数
3. RSI相对力度指数
4. %K%D随机指数
5. %R拉里·威廉斯指数

如果单纯地以该指标来进行操作，会有以下的结果(第2个指标没有回测；以下都是日周期的结果，原因是其他周期惨不忍睹；每个标的都是选取5个最好的参数)：

| 策略 | 标的 | 年化收益     | 年化收益回撤比 | 累计净值    |
| ---- | ---- | ------------ | -------------- | ----------- |
| ROC  | btc  | 1.174125986  | 2.224403738    | 11.0582382  |
| RSI  | btc  | 1.072732534  | 2.31663654     | 8.646893631 |
| %K%D | btc  | 0.639996048  | 0.96211594     | 4.582430639 |
| %R   | btc  | -0.472762385 | -0.447489255   | 0.944854711 |
| ROC  | eos  | 1.24164862   | 2.993421348    | 6.552156097 |
| RSI  | eos  | 0.778567719  | 1.598392061    | 3.63962201  |
| %K%D | eos  | 1.536035556  | 6.286656477    | 8.405712678 |
| %R   | eos  | 0.506411022  | 0.7555505      | 2.592662734 |
| ROC  | eth  | 2.528624181  | 4.867490773    | 49.91585591 |
| RSI  | eth  | 1.371922023  | 2.460055626    | 12.70925004 |
| %K%D | eth  | 1.139447871  | 2.467959443    | 11.80324693 |
| %R   | eth  | 0.31622202   | 0.352416034    | 2.336150505 |

可以看到btc上RSI和ROC表现都很好，前者回撤更小而后者收益更大；eth上ROC远远甩开别的指标；eos上则是%K%D最好，收益其实没多高，但回撤很小，大概20%+......

当然会有人不喜欢看表格，没事我们准备了可视化的方法：

![2](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\1\2.PNG)

![3](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\1\3.PNG)

![4](https://raw.githubusercontent.com/xuelixunhua/xuelixunhua.github.io/main/assets\images\articles\quantization\期货市场技术分析\1\4.PNG)

综上，ROC不愧是书上第一个讲述的，效果就是好，但这些指标的共性缺点是只在日K周期上有效果，只有%K%D在全周期的普适性好：

| symbol | 年化收益    | 年化收益回撤比 | 累计净值    |
| ------ | ----------- | -------------- | ----------- |
| btc    | 1.970293065 | 3.238584596    | 42.25471119 |
| eos    | 2.596686743 | 6.69865011     | 21.54254871 |
| eth    | 1.431198617 | 2.588272854    | 17.56399644 |

### 构造一个结合移动平均线和摆动指数的策略

既然我们知道移动平均线在追踪趋势上有着不错的表现，而摆动指数可以在震荡区间追踪和识别极限区，那么我们把这两个指标结合在一起会发生什么样的反应呢？

那我们就来构建一个非常简单的策略：一根简单移动平均线+ROC(日K)。

按照在[移动平均线](【量化】可以靠一根简单移动平均线在数字货币里赚钱吗？ 'https://mp.weixin.qq.com/s?__biz=MzI1NTcxMzcxOA==&mid=2247485389&idx=1&sn=09ec21bafce507379ee7734a59a69856&chksm=ea308f14dd4706021be1e39e28d6f07e5f51582e6ca106e1c1fe7b8127f60ad9fe27ac47ee5b&token=541823951&lang=zh_CN#rd')那里的规则：收盘价上穿移动平均线，做多，收盘价下穿移动平均线，做空。

同时，判断ROC是否大于100，若大于则允许做多，否则不做，若小于则允许做空，否则不做。

连续在市，不存在空仓状态，这样一个策略，结果如下：

| 策略           | symbol | 年化收益    | 年化收益回撤比 | 累计净值    |
| -------------- | ------ | ----------- | -------------- | ----------- |
| 新策略         | btc    | 1.719338735 | 4.482908945    | 21.78143312 |
| 新策略         | eos    | 1.534622835 | 4.730028297    | 8.516511183 |
| 新策略         | eth    | 2.599383955 | 4.873579422    | 53.0472862  |
| 简单移动平均线 | btc    | 1.263270416 | 2.823976066    | 12.37056851 |
| 简单移动平均线 | eos    | 1.454925737 | 3.634954621    | 7.881942122 |
| 简单移动平均线 | eth    | 1.513185223 | 2.512807595    | 17.23816438 |
| ROC            | btc    | 1.174125986 | 2.224403738    | 11.0582382  |
| ROC            | eos    | 1.24164862  | 2.993421348    | 6.552156097 |
| ROC            | eth    | 2.528624181 | 4.867490773    | 49.91585591 |

可以看出btc和eos的效果提升很明显，而且这只是简单的拼接而已，再看下它的参数平原：

![simple_average_line_plus_roc-1D](C:\Users\xueli\python_file\coin_quant\program\期货市场技术分析\output\image\simple_average_line_plus_roc-1D.png)

以上就是摆动指数的回测内容了，有机会再来看看能不能做出来形态识别的算法。

